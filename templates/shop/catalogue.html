{% extends 'shop_template.html' %}
{% load staticfiles %}
{% block title %}Catalogue{% endblock %}
{% block content %}
{% csrf_token %}

<!--Product Cards-->
<div class="container-fluid">
        <div class="grid-prod" id="product-cards">

        {% for product in products %}
        <div class="card" id="{{ product.article_number }}">
                <!--Product Images-->
                <div class="carousel slide product-image" data-interval="false">
                    <div class="carousel-inner">
                        {% for image in productsImages %}
                            {% for product_query in image.product.all %}
                                {% if product_query == product %}
                                    <div class="carousel-item">
                                        <img class="all-images-icon get-all-images" src="{% static 'icons/all-images.png' %}"
                                        data-unique_identificator="{{ product.unique_identificator }}">
                                        <img src="{{ image.image.url }}" class="productImage">
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        <script>
                            $('.card[id="{{ product.article_number }}"]').find('.carousel-item').first().addClass('active');
                        </script>
                    </div>
                </div>
                <!--Product Info-->
                <div class="card-body">
                    <a class="card-title">{{ product.title }}</a>
                    <p class="card-text">{{ product.description }}<br><p class="card-price">{{ product.price }} PLN</p></p>
					<div class="card-btns">
                        <form class="get_all_product_images" data-unique_identificator="{{ product.unique_identificator }}">{% csrf_token %}
                        </form>
                    <div class="btn-group">
        				<button type="button" class="btn btn-buy">Купить</button>
        				<button type="button" class="btn btn-icon-buy"><i class="fa fa-shopping-basket" aria-hidden="true"></i></button>
                	</div>
					<div class="btn-group">
        				<button type="button" class="btn btn-info" onclick="window.location.href='{% url 'productDetail' product.article_number %}'">Информация</button>
        				<button type="button" class="btn btn-icon-info" onclick="window.location.href='{% url 'productDetail' product.article_number %}'"><i class="fa fa-info" aria-hidden="true"></i></button>
                	</div>
				</div>
            	</div>
			</div>
        {% endfor %}
        </div>
</div>

<!--Big Images-->
	<div class="img-block">
        <i class="fa fa-times close-icon" id="close_images_block" aria-hidden="true"></i>
        <div class="mini-img-list"></div>
    </div>

</div>
{% endblock %}

{% block js %}
    <script>
        $('.img-block').hide();
        $('.get-all-images').hide();

        //наведение на карточку
        $('.card').hover(function () {
            $(this).find('.get-all-images').show();
        }, function () {
            $(this).find('.get-all-images').hide();
        });

        //ajax загрузка изображений артикула
        $('body').on('click', '.get-all-images', function (){
            var token = $('input[name="csrfmiddlewaretoken"]').val();
            var unique_identificator = $(this).data('unique_identificator');

            $.ajax({
                url: "{% url 'get_all_product_images' %}",
                method: 'post',
                data: {
                    'csrfmiddlewaretoken':token,
                    'unique_identificator':unique_identificator
                },
                success: function (data) {
                    $block_to_paste_images=$('.img-block');
                    console.log(data.images);
                    $block_to_paste_images.slideDown(function (img) {
                    $block_to_paste_images.prepend('<img class="big-img-item" src="' + data.images[0] + '">');
                    for (i=0; i<data.images.length; i++){
                        $block_to_paste_images.find('.mini-img-list').append('<img class="mini-img" src="' + data.images[i] + '"></a>');
                     }

                    });
                }

            });

            //клик на маленькое изображение и загрузка в большое
            $('.img-block').on('click', '.mini-img', function() {
                var img=$(this);
                console.log(img.attr('src'));
                $('.big-img-item').attr('src', img.attr('src'));
            })
        });

        //закрытие блока с загруженными изображениями
        $('#close_images_block').click(function () {
            $('.img-block').find('img').remove();
            $('.img-block').slideUp();
        });

    //*сортировка*//
    $('body').on('change', '#get_sort', function () {
        var sort_by = $(this).find('option:selected').val();
        var token = $('input[name="csrfmiddlewaretoken"]').val();
        var unique_identificator = '{{ category.unique_identificator }}';
        $.ajax({
            url: '{% url 'getSortQuery' %}',
            method: 'POST',
            data:{
                'csrfmiddlewaretoken':token,
                'sort_by':sort_by,
                'unique_identificator':unique_identificator,
            },
            success:function (data) {
                $('.card').hide();
                for (one_product=0; one_product<data.data.length; one_product++){
                    $one_product_card = $('#product-cards').append($('#hidden-template').html());
                    generate_one_product_card(data.data[one_product]);
                }
                /*for(i=0; i<data.data.length; i++){
                console.log(data.data)
                }*/
            },
            error:console.log('error')
        })
    });

    //*генерация карточки*//
    function generate_one_product_card(product_query) {
        $this_card = $('.card').last();
        $this_card.attr('id', product_query.article_number);
        $this_card.find('.card-title').text(product_query.title);
        $this_card.find('.card-text').text(product_query.description);
        $this_card.find('.card-price').text(product_query.price + ' PLN');
        $this_card.find('.get_all_product_images').attr('data-unique_identificator', product_query.unique_identificator);
        $this_card.find('.btn-info').attr('onclick', 'window.location.href=' + "'/shop/product_detail/product=" + product_query.unique_identificator + "'")

    }

    </script>

    <!-- шаблон карточки продукта-->
    <script id="hidden-template" type="text/x-custom-template">
        <div class="card" id="">
                <!--Product Images-->
                <div class="carousel slide product-image" data-interval="false">
                    <div class="carousel-inner">
                                    <div class="carousel-item">
                                        <img class="all-images-icon get-all-images" src="{% static 'icons/all-images.png' %}"
                                        data-unique_identificator="">
                                        <img src="" class="productImage active">
                                    </div>
                    </div>
                </div>
                <!--Product Info-->
                <div class="card-body">
                    <a class="card-title"></a>
                    <p class="card-text"><br><p class="card-price"></p></p>
					<div class="card-btns">
                        <form class="get_all_product_images" data-unique_identificator="">{% csrf_token %}
                        </form>
                    <div class="btn-group">
        				<button type="button" class="btn btn-buy">Купить</button>
        				<button type="button" class="btn btn-icon-buy"><i class="fa fa-shopping-basket" aria-hidden="true"></i></button>
                	</div>
					<div class="btn-group">
        				<button type="button" class="btn btn-info" onclick="window.location.href=''">Информация</button>
        				<button type="button" class="btn btn-icon-info" onclick="window.location.href=''"><i class="fa fa-info" aria-hidden="true"></i></button>
                	</div>
				</div>
            	</div>
			</div>
    </script>
{% endblock %}
