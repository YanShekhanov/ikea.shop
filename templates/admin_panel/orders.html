{% extends 'shop_template.html' %}
{% block title %}Заказы{% endblock %}

﻿<!--Admin-->
	<div class="grid" id="admin">
		<div class="admin-menu">
			<div class="btn-adm">Обновить товары</div>
			<div class="btn-adm">Загрузить артикулы</div>
			<div class="btn-adm">Заказы клиентов</div>
		</div>
		<select id="order-sort">
            <option>Фильтрация по статусу заказа</option>
            <option value="increase">Пункт сортировки 1</option>
            <option value="decline">Пункт сортировки 2</option>
            <option value="from_A_to_Z">Пункт сортировки 3</option>
            <option value="from_Z_to_A">Пункт сортировки 4</option>
        </select>
		<div id="order-info">
			<p class="adm-title">Статус заказа:
				<select id="order-stat">
            		<option>Оплачено</option>
            		<option value="increase">Не оплачено</option>
            		<option value="decline">Заказано</option>
            		<option value="from_A_to_Z">Готово</option>
            		<option value="from_Z_to_A">дпдклдлдппдтд</option>
        		</select></p>
			<p>Дата заказа: <b>12.05.2018</b></p>
			<p>Уникальный индетификатор: <b>5492924892</b></p>
			<div class="button-item" id="open-info">
     			<a href="#" class="btn-1">Открыть информацию о заказе<i class="fa fa-chevron-down" aria-hidden="true"></i></a>
    		</div>
			<div class="button-item" id="close-info">
     			<a href="#" class="btn-1">Скрыть информацию о заказе<i class="fa fa-chevron-down" aria-hidden="true"></i></a>
    		</div>
			<div class="open-info">
				<p class="adm-title">Данные клиента:</p>
				<p>ФИО: <b>Головня Артем Андреевич</b> Телефон: <b>+380-123-45-67</b> E-mail: <b>golovnya.artem@gmail.com</b></p>
				<p class="adm-title">Способ отправки:</p>
				<p>Тип: <b>Новая Почта</b> Отделения: <b>№1</b> Адрес: <b>ул.Петровского 68</b></p>
				<p class="adm-title">Способ оплаты:</p>
				<p>Оплата: <b>Наложенный платеж</b></p>
				<div id="cart">
		        <div id="cart-price-total">
			<div class="cart-name"><h6>Название</h6></div>
			<div class="amount-cart"><h6>Количество</h6></div>
			<div class="cart-price"><h6>Цена за 1шт</h6></div>
			<div class="cart-total"><h6>Сумма</h6></div>
		</div>
		<div id="cart-item">
			<a>PERSISK KELIM GASHGAI<br>(12345646)</a>
			<div class="amount-cart"><input type="number" value="31" id="product_count" placeholder="Количество..."><h6>шт.</h6></div>
			<div class="cart-price"><h6>180332грн.</h6></div>
			<div class="cart-total"><h6>100000грн.</h6></div>
			<i class="fa fa-times-circle" aria-hidden="true"></i>
		</div>
		<div id="cart-offer">
			<h6>Сумма: 100000грн.</h6>
		</div>
	</div>
			</div>
		</div>
	</div>

{% block content %}
    {% for order in orders %}
        <div id="order-info" data-order_unique_identificator="{{ order.unique_identificator }}">
			<p class="adm-title">Статус заказа:
                <form class="change_order_status" method="POST">{% csrf_token %}
                {{ change_order_status_form.status }}
                    <input type="submit" value="Сохранить" style="display: none;">
                </form>
				<select id="order-stat">
            		<option>Оплачено</option>
            		<option value="increase">Не оплачено</option>
            		<option value="decline">Заказано</option>
            		<option value="from_A_to_Z">Готово</option>
            		<option value="from_Z_to_A">дпдклдлдппдтд</option>
        		</select></p>
			<p>Дата заказа: <b>{{ order.updated|date:'Y-m-d H:i' }}</b></p>
			<p>Уникальный индетификатор: <b>{{ order.unique_identificator }}</b></p>
			<div class="button-item" id="open-info">
     			<a href="#" class="btn-1">Открыть информацию о заказе<i class="fa fa-chevron-down" aria-hidden="true"></i></a>
    		</div>
			<div class="button-item" id="close-info">
     			<a href="#" class="btn-1">Скрыть информацию о заказе<i class="fa fa-chevron-down" aria-hidden="true"></i></a>
    		</div>
			<div class="open-info">
				<p class="adm-title">Данные клиента:</p>
				<p>ФИО: <b>Головня Артем Андреевич</b> Телефон: <b>+380-123-45-67</b> E-mail: <b>golovnya.artem@gmail.com</b></p>
				<p class="adm-title">Способ отправки:</p>
				<p>Тип: <b>Новая Почта</b> Отделения: <b>№1</b> Адрес: <b>ул.Петровского 68</b></p>
				<p class="adm-title">Способ оплаты:</p>
				<p>Оплата: <b>Наложенный платеж</b></p>
				<div id="cart">
		        <div id="cart-price-total">
			<div class="cart-name"><h6>Название</h6></div>
			<div class="amount-cart"><h6>Количество</h6></div>
			<div class="cart-price"><h6>Цена за 1шт</h6></div>
			<div class="cart-total"><h6>Сумма</h6></div>
		</div>
		<div id="cart-item">
			<a>PERSISK KELIM GASHGAI<br>(12345646)</a>
			<div class="amount-cart"><input type="number" value="31" id="product_count" placeholder="Количество..."><h6>шт.</h6></div>
			<div class="cart-price"><h6>180332грн.</h6></div>
			<div class="cart-total"><h6>100000грн.</h6></div>
			<i class="fa fa-times-circle" aria-hidden="true"></i>
		</div>
		<div id="cart-offer">
			<h6>Сумма: 100000грн.</h6>
		</div>
	</div>
			</div>
		</div>


        <div class="order" id="{{ order.unique_identificator }}">
            <h4>Уникальный идентификатор : {{ order.unique_identificator }}, date: {{ order.updated|date:"Y-m-d H:i" }}</h4>
            <h5>Общая стоимость: {{ order.order_price }},
                status: <form class="change_order_status" method="POST">{% csrf_token %}
                {{ change_order_status_form.status }}
                    <input type="submit" value="Сохранить" style="display: none;">
                </form>
                <script>get_select_value(status={{ order.status }},$('.order').last().find('select[name="status"]'))</script>

            {% for order_info in orders_info %}
                {% if order_info.order == order %}
                    <h6>ФИО: {{ order_info.sorname }} {{ order_info.name }} {{ order_info.second_name }}<br>
                        Телефон: {{ order_info.phone }}, Email: {{ order_info.email }}
                    </h6>
                {% endif %}
            {% endfor %}

            {% for order_delivery in orders_delivery %}
                {% if order_delivery.order == order %}
                    Данные для отправки: {{ order_delivery.method_readable }}
                {% endif %}
            {% endfor %}

            {% for order_payment in orders_payment %}
                {% if order_payment.order == order %}
                    Способ оплаты: {{ order_payment.method_readable }}
                {% endif %}
            {% endfor %}
            <div class="products" style="display: none"></div>

            <button class="show_product_in_order" data-order_identificator="{{ order.unique_identificator }}">Показать детали заказа</button>
            <button class="close_product_in_order" data-order_identificator="{{ order.unique_identificator }}" style="display: none">Скрыть детали заказа</button>

        </div>
    {% endfor %}
{% endblock %}

{% block templates %}
    <script type="text/productTemplate" id="product_template">
        <div class="product" id="<%article_number%>">
            <img src="<%image_url%>"><%title%>, <%article_number%>, count: <%count%>, per one: <%price_per_one%>, summ: <%price%>
        </div>
    </script>
{% endblock %}

{% block js %}
    <script>function get_select_value(status, object) {
        console.log(status, object);
        object.find('option[value="' + status + '"]').attr('selected', 'selected');
        console.log('status selected');
    }
    </script>
{% endblock %}

{% block onload_js %}
    <script>
        //изменения статуса заказа
        $('.order').on('change', 'select[name="status"]', function () {
            $form = $(this).parents('form');
            $form.find('input[type="submit"]').show();
            $form.submit(function (e) {
                e.preventDefault();
                var status = $(this).find('select[name="status"]').val(),
                    unique_identificator = $(this).parents('.order').attr('id'),
                    token = $('input[name="csrfmiddlewaretoken"]').val(),
                    data = {'status':status, 'unique_identificator':unique_identificator, 'csrfmiddlewaretoken':token};
                $.ajax({
                    url:'{% url "change_order_status" %}',
                    method:'POST',
                    data:data,
                    success:function () {
                        alert('ok');
                    },
                    error:function (){
                        alert('error');
                    }
                })
            })
            });

        $('body').on('click', '.show_product_in_order', function () {
            var unique_identificator = $(this).data('order_identificator'),
                token = $('input[name="csrfmiddlewaretoken"]').val(),
                template = document.getElementById('product_template').innerHTML,
                button = $(this);
            $.ajax({
                url: '{% url "order_detail" %}',
                method: 'POST',
                data:{
                    'csrfmiddlewaretoken':token,
                    'unique_identificator':unique_identificator,
                },
                success: function (data) {
                    render_products(data, template, button);
                },
                error:function () {
                    alert('error');
                }
            })

        });

        function render_products(data, template, button) {
            Mustache.tags = ['<%','%>'];
            var product_template = template;
            for (i=0; i<data.products.length; i++){
                var query = data.products[i],
                    unique_identificator = data.unique_identificator;
                rendered_data = {
                    image_url: query.image,
                    title: query.title,
                    article_number:query.article_number,
                    price_per_one:query.price_per_one,
                    price:query.price,
                    count:query.count,
                };
                var rendered_template = Mustache.render(product_template, rendered_data);
                $('#' + unique_identificator).find('.products').append(rendered_template);
            }

            //кнопка меняет содержимое
            button.hide();
            button.siblings('.close_product_in_order').show();
            button.siblings('.products').show();

        }

        //зыкрытие дополнительных товаров
        $('body').on('click', '.close_product_in_order', function () {
            $(this).hide();
            $('.products').hide();
            $('.product').remove();
            $(this).siblings('.show_product_in_order').show();
        })
    </script>
{% endblock %}