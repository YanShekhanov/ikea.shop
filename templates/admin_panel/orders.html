{% extends 'shop_template.html' %}
{% block title %}Заказы{% endblock %}

{% block content %}
    {% for order in orders %}
        <div class="order">
            <h4>Уникальный идентификатор : {{ order.unique_identificator }}</h4>
            <h5>Общая стоимость: {{ order.order_price }}, status: {{ order.get_status_display|upper }}<button value="{{ order.unique_identificator }}">Изменить</button></h5>
            {% for order_info in orders_info %}
                {% if order_info.order == order %}
                    <h6>ФИО: {{ order_info.sorname }} {{ order_info.name }} {{ order_info.second_name }}<br>
                        Телефон: {{ order_info.phone }}, Email: {{ order_info.email }}
                    </h6>
                {% endif %}
            {% endfor %}

            {% for order_delivery in orders_delivery %}
                {% if order_delivery.order == order %}
                    Данные для отправки: {{ order_delivery.method_readable }}
                {% endif %}
            {% endfor %}

            {% for order_payment in orders_payment %}
                {% if order_payment.order == order %}
                    Способ оплаты: {{ order_payment.method_readable }}
                {% endif %}
            {% endfor %}

            <button class="show_product_in_order" data-order_identificator="{{ order.unique_identificator }}">Показать детали заказа</button>

        </div>
    {% endfor %}
{% endblock %}

{% block templates %}
    <script type="text/productTemplate" id="product_template">
        <img src="<%image%>"><%title%>, <%article_number%>, count: <%count%>, per one: <%price_per_one%>, summ: <%price%>
    </script>
{% endblock %}

{% block onload_js %}
    <script>
        $('body').on('click', '.show_product_in_order', function () {
            var unique_identificator = $(this).data('order_identificator'),
                token = $('input[name="csrfmiddlewaretoken"]').val(),
                template = document.getElementById('product_template').innerHTML;
            $.ajax({
                url: '{% url "order_detail" %}',
                method: 'POST',
                data:{
                    'csrfmiddlewaretoken':token,
                    'unique_identificator':unique_identificator,
                },
                success: function (data) {
                    render_products(data.products, template);
                },
                error:function () {
                    alert('error');
                }
            })

        });

        function render_products(data, template) {
            Mustache.tags = ['<%','%>'];
            var product_template = template;
            for (i=0; i<data.length; i++){
                var query = data[i];
                rendered_data = {
                    'image': query.image,
                    'title': query.title,
                    'article_number':query.article_number,
                    'price_per_one':query.price_per_one,
                    'price':query.price,
                    'count':query.count,
                };
                var rendered_template = Mustache.render(product_template, rendered_data);
                console.log(rendered_template);
            }
        }
    </script>
{% endblock %}