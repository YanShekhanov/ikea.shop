{% extends 'shop_template.html' %}

{% block title %}Корзина{% endblock %}

{% block content %}
    <div id="order" data-order_unique_identificator="{{ order.unique_indetificator }}">
    <h3>Уникальный идентификатор заказа: <span>{{ order.unique_identificator }}</span></h3>
    <table>
        <tr>
            <th></th>
            <th>НАЗВАНИЕ</th>
            <th>АРТИКУЛ</th>
            <th>КОЛ-ВО</th>
            <th>ЦЕНА ЗА ЕДИНИЦУ</th>
            <th>СУММА</th>
        </tr>
        {% for product in products %}
            <tr id="product_card" data-unique_identificator="{{ product.product.unique_identificator }}">
                {% for image in images %}
                    {% for product_image in image.product.all %}
                        {% if product_image == product.product %}
                            <td><img src="{{ image.image.url }}"></td>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                <td>{{ product.product.title }}</td>
                <td>{{ product.product.article_number }}</td>
                <td><input type="number" value="{{ product.count }}" id="product_count"> шт.</td>
                <td>{{ product.price_per_one }}</td>
                <td>{{ product.price }}</td>
            </tr>
        {% endfor %}

        {{ order.order_price }}, status {{ order.status }}
    </table>
    </div>
{% endblock %}

{% block onload_js %}
    <script>
        $('#order').on('change', '#product_count', function () {
            var product_unique_identificator = $(this).parents('#product_card').data('unique_identificator'),
                order_unique_identificator = $(this).parents('#order').data('order_unique_identificator'),
                count = $(this).val(),
                token = $('input[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                url:'{% url "change_product" %}',
                method:'POST',
                data:{
                    "csrfmiddlewaretoken":token,
                    "product_unique_identificator":product_unique_identificator,
                    "order_unique_identificator":order_unique_identificator,
                    "count":count,
                },
                success:function (data) {
                    console.log(data.success_message)
                },
                error:function () {
                    console.log('error')
                },
            })
        })
    </script>
{% endblock %}