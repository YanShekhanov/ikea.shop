{% extends 'shop_template.html' %}

{% block title %}Корзина{% endblock %}

{% block content %}
    {% if ExistError %}<h3>Ваша корзина пуста</h3>

    {% else %}
    <div id="order" data-order_unique_identificator="{{ order.unique_identificator }}">
    <table>
        <tr>
            <th></th>
            <th></th>
            <th>НАЗВАНИЕ</th>
            <th>АРТИКУЛ</th>
            <th>КОЛ-ВО</th>
            <th>ЦЕНА ЗА ЕДИНИЦУ</th>
            <th>СУММА</th>
        </tr>
        {% for product in products %}
            <tr id="product_card" data-product_unique_identificator="{{ product.product.unique_identificator }}" class="product_card">
                <td><button value="delete"
                onclick="delete_product_from_basket(event, $('#order').data('order_unique_identificator'),
                                                    $(this).parents('#product_card').data('product_unique_identificator'))">
                </button></td>
                {% for image in images %}
                    {% for product_image in image.product.all %}
                        {% if product_image == product.product %}
                            <td><img src="{{ image.image.url }}"></td>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                <td>{{ product.product.title }}</td>
                <td>{{ product.product.article_number }}</td>
                <td><input type="number" value="{{ product.count }}" id="product_count"> шт.</td>
                <td id="price_per_one">{{ product.price_per_one }} грн</td>
                <td id="price">{{ product.price }} грн</td>
            </tr>
        {% endfor %}
        <tr><td></td><td></td><td></td><td></td><td></td><td>СУММА</td><td>{{ order.order_price }} грн</td></tr>
    </table>
    </div>
    {% endif %}
{% endblock %}

{% block js %}
    <script type="text/productInOrder" id="product_in_order_template">
    <tr id="product_card" data-product_unique_identificator="<%product_unique_identificator%>" class="product_card">
                <td><button value="delete"
                onclick="delete_product_from_basket(event, $('#order').data('order_unique_identificator'),
                                                    $(this).parents('#product_card').data('product_unique_identificator'))">
                </button></td>
                <td><img src="<%image_url%>"></td>
                <td><%product_title%></td>
                <td><%article_number%></td>
                <td><input type="number" value="<%count%>" id="product_count"> шт.</td>
                <td id="price_per_one"><%price_per_one%> грн</td>
                <td id="price"><%price%> грн</td>
            </tr>
    </script>

    <script type="text/orderTemplate" id="order_template">
        <tr>
            <tr><td></td><td></td><td></td><td></td><td></td><td>СУММА</td><td><%summ%> грн</td>
        </tr>
    </script>
{% endblock %}

{% block onload_js %}
    <script>
        $('#order').on('change', '#product_count', function () {
            var product_unique_identificator = $(this).parents('#product_card').data('product_unique_identificator'),
                order_unique_identificator = $(this).parents('#order').data('order_unique_identificator'),
                count = $(this).val(),
                token = $('input[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                url:'{% url "change_product" %}',
                method:'POST',
                data:{
                    "csrfmiddlewaretoken":token,
                    "product_unique_identificator":product_unique_identificator,
                    "order_unique_identificator":order_unique_identificator,
                    "count":count,
                },
                success:function (data) {
                    console.log(data.success_message);
                    refresh_basket();
                },
                error:function () {
                    console.log('error')
                },
            })
        });

        function refresh_basket() {
            $.ajax({
                url:'{% url "refresh_basket" %}',
                method:'GET',
                success:function (data) {
                    $('.product_card').remove();
                    var product_template = document.getElementById('product_in_order_template').innerHTML,
                        order_template = document.getElementById('order_template').innerHTML;
                    generate_page(data, product_template, order_template);
                },
                error:function () {
                    console.log('error');
                },
            })
        }

        function generate_page(data, product_template, order_template) {
            Mustache.tags = ['<%', '%>'];
            for (i=0; i<data.products.length; i++){
                var query = data.products[i],
                    rendered_data = {
                    'product_unique_identificator':query.product_unique_identificator,
                    'image_url':query.image_url,
                    'article_number':query.article_number,
                    'product_title':query.product_title,
                    'count':query.count,
                    'price_per_one':query.price_per_one,
                    'price':query.price,
                };
                var rendered_html = Mustache.render(product_template, rendered_data);
                $('tbody').append(rendered_html);
            }
            var order_info = {'summ':data.order_price},
                rendered_order_info = Mustache.render(order_template, order_info);
                console.log(rendered_order_info);
            $('tbody').append(rendered_order_info);
        }

        function delete_product_from_basket(e, order_unique_identificator, product_unique_identificator) {
            e.preventDefault();
            var order_identificator = order_unique_identificator,
                product_identificator = product_unique_identificator,
                token = $('input[name="csrfmiddlewaretoken"]').val();
            console.log(order_identificator, '+', product_identificator);

            $.ajax({
                url:'{% url 'delete_product_from_basket' %}',
                method:'POST',
                data:{
                    'csrfmiddlewaretoken':token,
                    'product_identificator':product_identificator,
                    'order_identificator':order_identificator,
                },
                success: function (data) {
                    $('#product_card[data-product_unique_identificator="' + product_identificator + '"]').slideUp(600, function () {
                        $(this).remove()
                    });
                },
                error: function () {
                    console.log('error')
                }
            })

        }


    </script>
{% endblock %}